<!DOCTYPE html>
<html>
<head>
  <title>GasJo-OjekOnline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 400px; }
    button { padding: 10px 20px; margin: 5px; }
  </style>
</head>
<body>
  <h2>Tracking Perjalanan</h2>
  <button onclick="mulaiTracking()">Mulai</button>
  <button onclick="selesaiTracking()">Selesai</button>
  <p>Jarak Tempuh: <span id="jarak">0</span> meter</p>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([-6.2, 106.8], 15);
    let posisiSebelumnya = null;
    let totalJarak = 0;
    let tracking = false;
    let watchId;
    let polyline = L.polyline([], { color: 'blue' }).addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data Â© OpenStreetMap contributors'
    }).addTo(map);

    function mulaiTracking() {
      totalJarak = 0;
      posisiSebelumnya = null;
      polyline.setLatLngs([]);
      tracking = true;

      if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(updatePosisi, null, {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000
        });
      } else {
        alert("Geolocation tidak didukung di browser ini.");
      }
    }

    function selesaiTracking() {
      tracking = false;
      navigator.geolocation.clearWatch(watchId);
      document.getElementById("jarak").innerText = totalJarak.toFixed(2);
    }

    function updatePosisi(pos) {
      const latlng = [pos.coords.latitude, pos.coords.longitude];

      L.marker(latlng).addTo(map);
      polyline.addLatLng(latlng);
      map.panTo(latlng);

      if (posisiSebelumnya) {
        const jarak = hitungJarak(posisiSebelumnya, latlng);
        totalJarak += jarak;
      }

      posisiSebelumnya = latlng;
    }

    function hitungJarak(p1, p2) {
      const toRad = deg => deg * Math.PI / 180;
      const R = 6371e3;
      const lat1 = toRad(p1[0]);
      const lat2 = toRad(p2[0]);
      const dLat = toRad(p2[0] - p1[0]);
      const dLon = toRad(p2[1] - p1[1]);

      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1) * Math.cos(lat2) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // hasil dalam meter
    }
  </script>
</body>
</html>
